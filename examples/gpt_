#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import asyncio
import os
import sys
from typing import List, Dict, Optional, Tuple
from dotenv import load_dotenv
from pocketoptionapi_async import AsyncPocketOptionClient
from pocketoptionapi_async.constants import ASSETS

# ==========================
# Utils
# ==========================

def calculate_rsi(prices: List[float], period: int = 14) -> Optional[float]:
    if len(prices) < period + 1:
        return None

    deltas = [prices[i] - prices[i - 1] for i in range(1, len(prices))]
    gains = [d if d > 0 else 0 for d in deltas[:period]]
    losses = [-d if d < 0 else 0 for d in deltas[:period]]

    avg_gain = sum(gains) / period
    avg_loss = sum(losses) / period

    for d in deltas[period:]:
        avg_gain = ((period - 1) * avg_gain + max(d, 0)) / period
        avg_loss = ((period - 1) * avg_loss + max(-d, 0)) / period

    if avg_loss == 0:
        return 100.0

    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))


def calculate_ema(prices: List[float], period: int = 50) -> Optional[float]:
    if len(prices) < period:
        return None

    ema = sum(prices[:period]) / period
    multiplier = 2 / (period + 1)

    for price in prices[period:]:
        ema = (price - ema) * multiplier + ema

    return ema


def is_strong_candle(candle) -> bool:
    body = abs(candle.close - candle.open)
    total = candle.high - candle.low
    return total > 0 and (body / total) > 0.7


def has_trend_context(candles, direction: str) -> bool:
    if len(candles) < 4:
        return False

    c1 = candles[-2]
    c2 = candles[-3]

    if direction == "bullish":
        return c1.close < c1.open and c2.close < c2.open

    if direction == "bearish":
        return c1.close > c1.open and c2.close > c2.open

    return False


def is_pin_bar(candle) -> Optional[str]:
    body = abs(candle.close - candle.open)
    total = candle.high - candle.low
    if total == 0:
        return None

    upper = candle.high - max(candle.open, candle.close)
    lower = min(candle.open, candle.close) - candle.low

    if lower > body * 2 and upper < body * 0.5:
        return "bullish"

    if upper > body * 2 and lower < body * 0.5:
        return "bearish"

    return None


def is_engulfing(curr, prev) -> Optional[str]:
    if prev.close < prev.open and curr.close > curr.open:
        if curr.open < prev.close and curr.close > prev.open:
            return "bullish"

    if prev.close > prev.open and curr.close < curr.open:
        if curr.open > prev.close and curr.close < prev.open:
            return "bearish"

    return None


def get_otc_assets():
    return [a for a in ASSETS if a.endswith("_otc")]

# ==========================
# Scanner
# ==========================

async def scan_asset(client, asset: str, timeframe="5m") -> Optional[Dict]:
    candles = await client.get_candles(asset, timeframe, count=60)
    if len(candles) < 55:
        return None

    current = candles[-1]
    previous = candles[-2]

    if is_strong_candle(current):
        return None

    closes = [c.close for c in candles]
    rsi = calculate_rsi(closes)
    ema50 = calculate_ema(closes)

    if rsi is None or ema50 is None:
        return None

    score = 0
    signal = None
    pattern = ""

    pin = is_pin_bar(current)
    engulf = is_engulfing(current, previous)

    # ===== CALL =====
    if rsi <= 35:
        if rsi <= 30:
            score += 30
        else:
            score += 15

        if current.close < ema50:
            score += 20
        else:
            return None

        if has_trend_context(candles, "bullish"):
            score += 20
        else:
            return None

        if pin == "bullish":
            score += 20
            pattern = "Bullish Pin Bar"
        elif engulf == "bullish":
            score += 30
            pattern = "Bullish Engulfing"

        if score >= 70:
            signal = "CALL"

    # ===== PUT =====
    if rsi >= 65:
        score = 0

        if rsi >= 70:
            score += 30
        else:
            score += 15

        if current.close > ema50:
            score += 20
        else:
            return None

        if has_trend_context(candles, "bearish"):
            score += 20
        else:
            return None

        if pin == "bearish":
            score += 20
            pattern = "Bearish Pin Bar"
        elif engulf == "bearish":
            score += 30
            pattern = "Bearish Engulfing"

        if score >= 70:
            signal = "PUT"

    if signal:
        return {
            "asset": asset,
            "signal": signal,
            "score": score,
            "pattern": pattern,
            "rsi": round(rsi, 2),
            "price": current.close,
            "timeframe": timeframe
        }

    return None

# ==========================
# MAIN
# ==========================

async def main():
    load_dotenv()
    SSID = os.getenv("POCKETOPTION_SSID")
    client = AsyncPocketOptionClient(SSID, is_demo=True)
    await client.connect()

    assets = get_otc_assets()
    print(f"Scanning {len(assets)} OTC assets...\n")

    for asset in assets:
        res = await scan_asset(client, asset)
        if res:
            print(
                f"ðŸŽ¯ {res['asset']} | {res['signal']} | "
                f"Score: {res['score']} | RSI: {res['rsi']} | {res['pattern']}"
            )
        await asyncio.sleep(0.05)

    await client.disconnect()

if __name__ == "__main__":
    asyncio.run(main())
